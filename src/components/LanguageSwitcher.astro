---
interface Props {
  currentLocale?: string;
}

const { currentLocale = "es" } = Astro.props;
---

<div class="language-switcher-container relative z-[110]">
  <button
    type="button"
    id="lang-switch-btn"
    class="lang-switch-btn group relative flex items-center gap-3 px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 backdrop-blur-md border border-white/10 hover:border-purple-500/50 transition-all duration-500 overflow-hidden"
    aria-label="Switch Language"
    data-current-lang={currentLocale}
  >
    <!-- Background Glow Effect -->
    <div
      class="absolute inset-0 bg-gradient-to-r from-purple-600/20 to-blue-600/20 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
    >
    </div>

    <!-- Content -->
    <div class="relative flex items-center gap-2">
      <div
        class="flex items-center justify-center w-6 h-6 rounded-full bg-white/10 text-xs font-bold"
      >
        <span id="lang-flag" class="lang-flag"
          >{currentLocale === "es" ? "ES" : "EN"}</span
        >
      </div>
      <span
        id="lang-label"
        class="lang-label text-xs font-bold tracking-widest uppercase text-white/90 group-hover:text-white transition-colors"
      >
        {currentLocale === "es" ? "ESPAÑOL" : "ENGLISH"}
      </span>
    </div>

    <!-- Indicator Dot -->
    <div
      class="relative w-1.5 h-1.5 rounded-full bg-purple-500 shadow-[0_0_8px_rgba(147,51,234,0.8)]"
    >
    </div>
  </button>
</div>

<script>
  import en from "../locales/en.json";
  import es from "../locales/es.json";

  const translations = { en, es };

  function initLanguageSwitcher() {
    const btns = document.querySelectorAll(".lang-switch-btn");

    if (btns.length === 0) return;

    // Initial state from localStorage
    const savedLang = localStorage.getItem("preferredLang") as "en" | "es";
    if (savedLang && savedLang !== btns[0].getAttribute("data-current-lang")) {
      applyLanguage(savedLang);
    }

    btns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const currentLang = btn.getAttribute("data-current-lang") as
          | "en"
          | "es";
        const newLang = currentLang === "es" ? "en" : "es";
        applyLanguage(newLang);
      });
    });
  }

  function applyLanguage(newLang: "en" | "es") {
    const btns = document.querySelectorAll(".lang-switch-btn");
    const t = translations[newLang];

    btns.forEach((btn) => {
      const flag = btn.querySelector(".lang-flag");
      const label = btn.querySelector(".lang-label");

      // Update button state
      btn.setAttribute("data-current-lang", newLang);
      if (flag) flag.textContent = newLang.toUpperCase();
      if (label) label.textContent = newLang === "es" ? "ESPAÑOL" : "ENGLISH";
    });

    // Save to localStorage
    localStorage.setItem("preferredLang", newLang);

    // Update all translatable elements on the page
    updateContent(t);

    // Update document lang attribute
    document.documentElement.lang = newLang;

    // Dispatch event for mobile menu to sync
    const event = new CustomEvent("languageChange", {
      detail: { lang: newLang },
    });
    document.dispatchEvent(event);
  }

  function updateContent(t: any) {
    const btn = document.querySelector(".lang-switch-btn");
    const currentLang = btn?.getAttribute("data-current-lang") || "es";

    // Hero
    const heroHeadline = document.getElementById("hero-headline");
    const heroSubheadline = document.getElementById("hero-subheadline");
    const heroCta = document.getElementById("hero-cta");
    if (heroHeadline) heroHeadline.textContent = t.hero.headline;
    if (heroSubheadline) heroSubheadline.textContent = t.hero.subheadline;
    if (heroCta) heroCta.textContent = t.hero.cta;

    // Nav (Desktop & Mobile)
    const navLinks = document.querySelectorAll("[data-scroll]");
    navLinks.forEach((link) => {
      const target = link.getAttribute("data-scroll");
      const dataT = link.getAttribute("data-t");
      if (dataT) return; // Skip if it has data-t, it will be handled by the generic loop

      // Check if this is a mobile nav link (has mobile-nav-text child)
      const mobileNavText = link.querySelector(".mobile-nav-text");

      let newText = "";
      if (target === "services-section")
        newText =
          t.nav?.services || (currentLang === "es" ? "Servicios" : "Services");
      else if (target === "how-we-work-section")
        newText =
          t.nav?.howWeWork ||
          (currentLang === "es" ? "Cómo trabajamos" : "How We Work");
      else if (target === "meet-section")
        newText = t.nav?.about || (currentLang === "es" ? "Nosotros" : "About");
      else if (target === "contact-section")
        newText =
          t.nav?.contact || (currentLang === "es" ? "Contacto" : "Contact");

      // Update text differently for mobile vs desktop
      if (mobileNavText) {
        // Mobile: update only the text span
        mobileNavText.textContent = newText;
      } else {
        // Desktop: update the whole element
        link.textContent = newText;
      }
    });

    // We need to be more systematic if we want to translate EVERYTHING.
    // For now, let's target the main sections.

    // To make this truly robust, we'd need data attributes on all translatable elements.
    // Example: <h2 data-t="howWeWork.title">{t.howWeWork.title}</h2>

    const translatableElements = document.querySelectorAll("[data-t]");
    translatableElements.forEach((el) => {
      const key = el.getAttribute("data-t");
      if (key) {
        const value = key.split(".").reduce((obj, i) => obj?.[i], t);
        if (value) {
          // Check if this element is inside a mobile nav link structure
          const isMobileNavText = el.classList.contains("mobile-nav-text");

          if (key === "footer.lastUpdated") {
            const currentYear = new Date().getFullYear().toString();
            el.textContent = value.replace("${currentYear}", currentYear);
          } else if (isMobileNavText) {
            // For mobile nav text, just update the text content directly
            el.textContent = value;
          } else {
            el.textContent = value;
          }
        } else {
          console.warn(`Translation key not found: ${key}`);
        }
      }
    });
  }

  initLanguageSwitcher();
  document.addEventListener("astro:after-swap", initLanguageSwitcher);

  // Also run updateContent on load if there's a saved language
  document.addEventListener("DOMContentLoaded", () => {
    const savedLang = localStorage.getItem("preferredLang") as "en" | "es";
    if (savedLang) {
      const t = savedLang === "en" ? en : es;
      updateContent(t);
    }
  });

  // Listen for language change events from mobile menu
  document.addEventListener("languageChange", (e: any) => {
    const newLang = e.detail?.lang as "en" | "es";
    if (newLang && (newLang === "en" || newLang === "es")) {
      // Apply the language change
      applyLanguage(newLang);
    }
  });
</script>
